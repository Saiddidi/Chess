<!doctype html>

<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>محرك شطرنج يتعلم — ملف واحد</title>
  <style>
    /* بسيط ومناسب للهاتف */
    :root{--light:#f0d9b5;--dark:#b58863}
    html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#0f172a;color:#e6edf3}
    .app{max-width:980px;margin:10px auto;padding:12px}
    h1{font-size:18px;margin:0 0 8px}
    .board{display:grid;grid-template-columns:repeat(8,1fr);gap:0;border-radius:8px;overflow:hidden;touch-action:none;user-select:none}
    .sq{aspect-ratio:1/1;display:flex;align-items:center;justify-content:center;font-size:28px}
    .sq.light{background:var(--light);color:#000}
    .sq.dark{background:var(--dark);color:#000}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{background:#111827;color:#e6edf3;border:0;padding:8px 10px;border-radius:8px;font-size:14px}
    button.primary{background:#0ea5a4}
    aside{margin-top:10px;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px}
    .small{font-size:13px;color:#cbd5e1}
    input[type=file]{display:none}
    .row{display:flex;gap:8px;align-items:center}
    @media(min-width:720px){h1{font-size:22px}.sq{font-size:34px}}
  </style>
</head>
<body>
  <div class="app">
    <h1>محرك شطرنج يتعلم — ملف واحد (للجوال)</h1><!-- لوحة الشطرنج -->
<div id="board" class="board" role="grid" aria-label="لوح الشطرنج"></div>

<div class="controls">
  <button id="newBtn" class="primary">لعبة جديدة</button>
  <button id="engineMoveBtn">حركة المحرك</button>
  <button id="undoBtn">تراجع</button>
  <button id="toggleEngineBtn">إيقاف المحرك</button>
  <button id="flipBtn">قلب اللوح</button>
  <button id="resetBookBtn">حذف خبرة</button>
  <button id="exportBtn">تصدير الكتاب</button>
  <button id="importBtn">استيراد كتاب</button>
  <input id="fileInput" type="file" accept="application/json" />
</div>

<aside>
  <div class="row"><div class="small">الحالة: </div><div id="status" class="small">-</div></div>
  <div class="row"><div class="small">آخر نتيجة: </div><div id="lastResult" class="small">-</div></div>
  <div class="row"><div class="small">عدد مواضع الخبرة: </div><div id="bookSize" class="small">0</div></div>
  <div class="small" style="margin-top:6px">المحرك مبسّط: يتعلّم من كل مباراة ويخزن في <code>localStorage</code>. المحرك يلعب الجانب الأسود. ترقية القطع تلقائيًا إلى الملكة.</div>
</aside>

<script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0-beta.2/dist/chess.min.js"></script>
<script>
/*
  صفحة HTML متكاملة:
  - واجهة لمس/نقر تعمل على الهاتف
  - محرك تعلم بسيط يخزن كتاب الخبرة في localStorage بالمفتاح chess_learning_book_v1
  - المحرك يلعب الأسود بشكل افتراضي
  - كيفية اللعب: اضغط مربع المربع المصدر ثم المربع الوجهة
*/

// ---------- تحضير الرموز ----------
const PIECE_UNICODE = {
  'p': {'w':'♙','b':'♟'},
  'r': {'w':'♖','b':'♜'},
  'n': {'w':'♘','b':'♞'},
  'b': {'w':'♗','b':'♝'},
  'q': {'w':'♕','b':'♛'},
  'k': {'w':'♔','b':'♚'}
};

// ---------- محرك التعلم المبسّط ----------
class LearningEngine {
  constructor(){
    this.storageKey = 'chess_learning_book_v1';
    this.epsilon = 0.18; // استكشاف
    this.learningRate = 1;
    this.book = this._load();
    this.currentMoves = [];
  }
  _load(){
    try{ const raw = localStorage.getItem(this.storageKey); return raw ? JSON.parse(raw) : {}; }
    catch(e){console.error(e); return {};}
  }
  _save(){ try{ localStorage.setItem(this.storageKey, JSON.stringify(this.book)); }catch(e){console.error(e);} }
  chooseMove(chess){
    const moves = chess.moves({verbose:true});
    if (moves.length === 0) return null;
    const fen = chess.fen();
    if (Math.random() < this.epsilon){
      const m = moves[Math.floor(Math.random()*moves.length)];
      const key = m.san || (m.from + m.to);
      this.currentMoves.push({fen,move:key});
      return key;
    }
    const row = this.book[fen] || {};
    let best=null, bestScore=-Infinity;
    for (const m of moves){
      const key = m.san || (m.from + m.to);
      const sc = row[key] ?? 0;
      const score = sc + Math.random()*0.01;
      if (score>bestScore){ bestScore=score; best=key; }
    }
    if (!best){ const m = moves[0]; best = m.san || (m.from + m.to); }
    this.currentMoves.push({fen,move:best});
    return best;
  }
  onGameEnd(result){ // result: 'win'|'loss'|'draw' بالنسبة للمحرك
    let delta=0; if (result==='win') delta=this.learningRate; else if (result==='loss') delta=-this.learningRate; else delta=0;
    for (const r of this.currentMoves){ if (!this.book[r.fen]) this.book[r.fen]={}; if (!this.book[r.fen][r.move]) this.book[r.fen][r.move]=0; this.book[r.fen][r.move]+=delta; }
    this.currentMoves = [];
    this._save();
  }
  export(){ return JSON.stringify(this.book); }
  import(json){ try{ this.book = JSON.parse(json); this._save(); }catch(e){throw e;} }
  reset(){ this.book = {}; this._save(); }
  size(){ return Object.keys(this.book).length; }
}

// ---------- التطبيق ----------
const chess = new Chess();
const engine = new LearningEngine();
const boardEl = document.getElementById('board');
const statusEl = document.getElementById('status');
const lastResultEl = document.getElementById('lastResult');
const bookSizeEl = document.getElementById('bookSize');

let orientation = 'white'; // 'white' or 'black'
let selected = null; // مربع مثل 'e2'
let engineOn = true;

function renderBoard(){
  boardEl.innerHTML = '';
  // نرسم الصفوف من أعلى لأسفل (rank 8..1) ولكن حسب orientation
  const ranks = orientation==='white' ? [8,7,6,5,4,3,2,1] : [1,2,3,4,5,6,7,8];
  const files = orientation==='white' ? ['a','b','c','d','e','f','g','h'] : ['h','g','f','e','d','c','b','a'];
  for (let r of ranks){
    for (let f of files){
      const sq = f + r;
      const p = chess.get(sq);
      const fileIdx = files.indexOf(f);
      const rankIdx = ranks.indexOf(r);
      const light = (fileIdx + rankIdx) % 2 === 0;
      const div = document.createElement('button');
      div.className = 'sq ' + (light? 'light':'dark');
      div.dataset.square = sq;
      div.innerHTML = p ? PIECE_UNICODE[p.type][p.color] : '';
      div.addEventListener('click', onSquareClick);
      boardEl.appendChild(div);
    }
  }
  bookSizeEl.textContent = engine.size();
}

function onSquareClick(e){
  const sq = e.currentTarget.dataset.square;
  if (selected){
    // حاول التحريك
    const move = chess.move({from:selected,to:sq,promotion:'q'});
    selected = null; renderBoard();
    if (move){ checkGameOver(); if (engineOn) setTimeout(engineMove, 220); }
    return;
  }
  const p = chess.get(sq);
  if (p && p.color === 'w'){
    // نسمح للاعب الأبيض فقط باللعب هنا (محرك يلعب الأسود)
    selected = sq;
  }
}

function engineMove(){
  if (chess.game_over()) return;
  // المحرك يلعب الأسود
  if (chess.turn() !== 'b') return;
  const mv = engine.chooseMove(chess);
  if (!mv) return;
  chess.move(mv, {sloppy:true});
  renderBoard(); checkGameOver();
}

function checkGameOver(){
  if (chess.isCheckmate()){
    const winner = chess.turn() === 'w' ? 'black' : 'white';
    statusEl.textContent = 'Checkmate — الفائزة: ' + winner;
    const engineColor='b';
    const result = (winner === 'black') ? 'win' : 'loss';
    engine.onGameEnd(result);
    lastResultEl.textContent = result;
    bookSizeEl.textContent = engine.size();
  } else if (chess.isDraw() || chess.isStalemate() || chess.isInsufficientMaterial()){
    statusEl.textContent = 'تعادل أو نهاية بلا فائز';
    engine.onGameEnd('draw');
    lastResultEl.textContent = 'draw';
    bookSizeEl.textContent = engine.size();
  } else {
    statusEl.textContent = chess.turn() === 'w' ? 'دور الأبيض' : 'دور الأسود';
  }
}

// ---------- أزرار التحكم ----------
document.getElementById('newBtn').addEventListener('click', ()=>{ chess.reset(); engine.currentMoves=[]; selected=null; renderBoard(); statusEl.textContent=''; lastResultEl.textContent='-'; });
document.getElementById('engineMoveBtn').addEventListener('click', engineMove);
document.getElementById('undoBtn').addEventListener('click', ()=>{ chess.undo(); renderBoard(); });
document.getElementById('toggleEngineBtn').addEventListener('click', (e)=>{ engineOn = !engineOn; e.target.textContent = engineOn ? 'إيقاف المحرك' : 'تشغيل المحرك'; });
document.getElementById('flipBtn').addEventListener('click', ()=>{ orientation = orientation==='white' ? 'black' : 'white'; renderBoard(); });
document.getElementById('resetBookBtn').addEventListener('click', ()=>{ if (confirm('إعادة تعيين كتاب الخبرة وحذف كل ما تعلّم؟')){ engine.reset(); renderBoard(); alert('تم حذف الخبرة'); }});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const data = engine.export();
  // نسخ للحافظة أو فتح نافذة تنزيل
  if (navigator.clipboard){ navigator.clipboard.writeText(data).then(()=> alert('تم نسخ الكتاب للحافظة')); }
  else { const w = window.open('about:blank','_blank'); w.document.write('<pre>'+escapeHtml(data)+'</pre>'); }
});

document.getElementById('importBtn').addEventListener('click', ()=>{ document.getElementById('fileInput').click(); });
document.getElementById('fileInput').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if (!f) return; const txt = await f.text(); try{ engine.import(txt); alert('تم استيراد الكتاب'); renderBoard(); }catch(e){ alert('خطأ في تنسيق الملف'); }
});

function escapeHtml(s){ return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

// تفعيل اللمس السريع: اسحب ليس مدعوم هنا — تعتمد على نقر من ثم نقر الى
// اختصار: دبل-تاب لتحريك تلقائيًا إذا تريد

// رسم أولي
renderBoard(); checkGameOver();

// اختياري: جعل اللوح ذكيًا عند تغيير حجم الشاشة
window.addEventListener('resize', () => renderBoard());

</script>

  </div>
</body>
</html>
